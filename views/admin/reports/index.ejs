<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/admin.css" rel="stylesheet">
</head>
<body>
    <%- include('../../partials/admin-sidebar') %>
    <main class="admin-main">
        <%- include('../../partials/flash-messages') %>
        <h4 class="fw-bold mb-4"><i class="bi bi-graph-up me-2"></i>Báo cáo tài chính</h4>

        <!-- Bộ lọc thời gian -->
        <div class="form-card mb-4">
            <form method="GET" class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label">Từ ngày</label>
                    <input type="date" name="startDate" class="form-control" value="<%= startDate %>">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Đến ngày</label>
                    <input type="date" name="endDate" class="form-control" value="<%= endDate %>">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Chế độ xem</label>
                    <select name="viewMode" class="form-select">
                        <option value="day" <%= viewMode==='day'?'selected':'' %>>Theo ngày</option>
                        <option value="week" <%= viewMode==='week'?'selected':'' %>>Theo tuần</option>
                        <option value="month" <%= viewMode==='month'?'selected':'' %>>Theo tháng</option>
                    </select>
                </div>
                <div class="col-md-1"><button type="submit" class="btn btn-primary w-100"><i class="bi bi-funnel"></i></button></div>
                <div class="col-md-5 text-end">
                    <!-- Preset nhanh -->
                    <div class="btn-group btn-group-sm">
                        <a href="?startDate=<%= new Date().toISOString().split('T')[0] %>&endDate=<%= new Date().toISOString().split('T')[0] %>" class="btn btn-outline-primary">Hôm nay</a>
                        <a href="?startDate=<%= (() => { const d=new Date(); d.setDate(d.getDate()-6); return d.toISOString().split('T')[0]; })() %>&endDate=<%= new Date().toISOString().split('T')[0] %>" class="btn btn-outline-primary">7 ngày</a>
                        <a href="?startDate=<%= (() => { const d=new Date(); d.setDate(d.getDate()-29); return d.toISOString().split('T')[0]; })() %>&endDate=<%= new Date().toISOString().split('T')[0] %>" class="btn btn-outline-primary">30 ngày</a>
                        <a href="?startDate=<%= new Date().getFullYear() + '-01-01' %>&endDate=<%= new Date().toISOString().split('T')[0] %>" class="btn btn-outline-primary">Năm nay</a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Thẻ tổng hợp -->
        <div class="row g-3 mb-4">
            <div class="col-md-4 col-xl-2">
                <div class="stat-card text-center">
                    <div class="stat-label">Doanh thu</div>
                    <div class="stat-value text-success" style="font-size:20px"><%= Number(aggregate.total_revenue).toLocaleString('vi-VN') %>đ</div>
                </div>
            </div>
            <div class="col-md-4 col-xl-2">
                <div class="stat-card text-center">
                    <div class="stat-label">Chi phí</div>
                    <div class="stat-value text-warning" style="font-size:20px"><%= Number(aggregate.total_cost).toLocaleString('vi-VN') %>đ</div>
                </div>
            </div>
            <div class="col-md-4 col-xl-2">
                <div class="stat-card text-center">
                    <div class="stat-label">Lợi nhuận</div>
                    <div class="stat-value" style="font-size:20px;color:#a855f7"><%= Number(aggregate.total_profit).toLocaleString('vi-VN') %>đ</div>
                </div>
            </div>
            <div class="col-md-4 col-xl-2">
                <div class="stat-card text-center">
                    <div class="stat-label">Biên LN</div>
                    <div class="stat-value text-info" style="font-size:20px"><%= profitMargin %>%</div>
                </div>
            </div>
            <div class="col-md-4 col-xl-2">
                <div class="stat-card text-center">
                    <div class="stat-label">Số đơn</div>
                    <div class="stat-value" style="font-size:20px"><%= aggregate.total_orders %></div>
                </div>
            </div>
            <div class="col-md-4 col-xl-2">
                <div class="stat-card text-center">
                    <div class="stat-label">TB/đơn</div>
                    <div class="stat-value" style="font-size:20px"><%= Number(avgOrderValue).toLocaleString('vi-VN') %>đ</div>
                </div>
            </div>
        </div>

        <!-- Biểu đồ -->
        <div class="row g-3 mb-4">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h6 class="fw-bold mb-3">Doanh thu vs Chi phí vs Lợi nhuận</h6>
                    <canvas id="barChart" height="200"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h6 class="fw-bold mb-3">Xu hướng doanh thu & lợi nhuận</h6>
                    <canvas id="lineChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Xuất file & Bảng chi tiết -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0">Lịch sử bán hàng</h5>
            <div class="btn-group btn-group-sm">
                <a href="/admin/reports/export?format=csv&startDate=<%= startDate %>&endDate=<%= endDate %>&status=<%= filters.status %>" class="btn btn-outline-primary"><i class="bi bi-filetype-csv me-1"></i>CSV</a>
                <a href="/admin/reports/export?format=excel&startDate=<%= startDate %>&endDate=<%= endDate %>&status=<%= filters.status %>" class="btn btn-outline-primary"><i class="bi bi-file-earmark-excel me-1"></i>Excel</a>
            </div>
        </div>
        <div class="table-dark-custom">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead><tr><th>Ngày</th><th>Khách hàng</th><th>Sản phẩm</th><th>Giá bán</th><th>Chi phí</th><th>Lợi nhuận</th><th>TT</th></tr></thead>
                    <tbody>
                        <% orders.forEach(o => { %>
                        <tr>
                            <td class="text-nowrap"><%= o.sale_date %></td>
                            <td><%= o.customer_name %></td>
                            <td><%= o.product_name %></td>
                            <td class="text-success"><%= Number(o.actual_price).toLocaleString('vi-VN') %>đ</td>
                            <td class="text-warning"><%= Number(o.cost).toLocaleString('vi-VN') %>đ</td>
                            <td style="color:#a855f7"><%= Number(o.profit).toLocaleString('vi-VN') %>đ</td>
                            <td><% if(o.status==='paid'){%><span class="badge badge-paid">TT</span><%}else if(o.status==='pending'){%><span class="badge badge-pending">Chờ</span><%}else{%><span class="badge badge-cancelled">Hủy</span><%}%></td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
        <% if (totalPages > 1) { %>
        <nav class="mt-3"><ul class="pagination justify-content-center">
            <% for (let i = 1; i <= totalPages; i++) { %>
                <li class="page-item <%= i===currentPage?'active':'' %>"><a class="page-link" href="?page=<%= i %>&startDate=<%= startDate %>&endDate=<%= endDate %>&viewMode=<%= viewMode %>&search=<%= filters.search %>&status=<%= filters.status %>"><%= i %></a></li>
            <% } %>
        </ul></nav>
        <% } %>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        const stats = <%- JSON.stringify(stats) %>;
        const labels = stats.map(s => s.sale_date);
        const chartOpts = { responsive:true, plugins:{legend:{labels:{color:'#94a3b8'}}}, scales:{x:{ticks:{color:'#94a3b8'},grid:{color:'rgba(255,255,255,0.05)'}},y:{ticks:{color:'#94a3b8',callback:v=>(v/1000)+'k'},grid:{color:'rgba(255,255,255,0.05)'}}} };
        // Bar Chart
        new Chart(document.getElementById('barChart'), { type:'bar', data:{ labels, datasets:[
            {label:'Doanh thu',data:stats.map(s=>s.revenue),backgroundColor:'rgba(16,185,129,0.6)',borderRadius:4},
            {label:'Chi phí',data:stats.map(s=>s.cost),backgroundColor:'rgba(245,158,11,0.6)',borderRadius:4},
            {label:'Lợi nhuận',data:stats.map(s=>s.profit),backgroundColor:'rgba(168,85,247,0.6)',borderRadius:4}
        ]}, options:chartOpts });
        // Line Chart
        new Chart(document.getElementById('lineChart'), { type:'line', data:{ labels, datasets:[
            {label:'Doanh thu',data:stats.map(s=>s.revenue),borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.1)',fill:true,tension:0.3},
            {label:'Lợi nhuận',data:stats.map(s=>s.profit),borderColor:'#a855f7',backgroundColor:'rgba(168,85,247,0.1)',fill:true,tension:0.3}
        ]}, options:chartOpts });
    </script>
</body>
</html>

